<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/popper.min.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/icon/iconfont.css">
    <link rel="stylesheet" href="css/order.css">
    <link href="css/jquery.city.css" rel="stylesheet" />
    <link href="css/animate.min.css" rel="stylesheet" />
</head>

<body>
    <iframe src="./header.html" frameborder="0" scrolling="no" class="frame-div" onload="this.height=100"></iframe>
    <div class="container">
        <section>
            <div>
                <p></p>
                <p></p>
                <p> 确认购买</p>
            </div>
            <div>
                <div>
                    <ul>
                        <li>
                            <span>
                                订单详情
                            </span>
                            <span>
                                <a href="javascript:;">
                                    返回商家修改
                                </a>
                            </span>
                        </li>
                        <li>
                            <span>
                                菜品
                            </span>
                            <span>
                                份数/价格
                            </span>
                        </li>
                    </ul>
                    <div></div>
                </div>
                <div data-right="">
                    <h2 data-target="#modal" data-toggle="my-modal">
                        收货地址
                        <a href="javascript:;">
                            添加新地址
                        </a>
                    </h2>
                    <div>
                        <div>
                            <div class="add-address" data-add-address="">
                                <i>+</i>
                                <span>
                                    添加新地址
                                </span>
                            </div>

                            <div>
                                <h2>
                                    付款方式
                                    <span>
                                        推荐使用在线支付，不用找零，优惠更多
                                    </span>
                                </h2>
                                <div>
                                    <p>在线支付</p>
                                    <p>支持微信、支付宝、QQ钱包及大部分银行卡</p>
                                    <div class="tabs">
                                        <i class="iconfont">&#xebe6;</i>
                                    </div>
                                </div>
                            </div>
                            <div class="another-info">
                                <h2>
                                    其他信息
                                </h2>
                                <div>
                                    <span>送达时间</span>
                                    <p>
                                        立即送达
                                        <i class="iconfont">&#xeb6d;</i>
                                    </p>
                                    <div class="time">
                                        <ul>
                                            <li>立即送达</li>
                                            <li>16:30</li>
                                            <li>17:00</li>
                                            <li>17:30</li>
                                            <li>18:00</li>
                                            <li>18:30</li>
                                            <li>19:00</li>
                                        </ul>
                                    </div>
                                </div>
                                <div>
                                    <span>订单备注</span>
                                    <input type="text" name="order_descript" id="order_descript">
                                </div>
                                <div>
                                    <span>餐具份数</span>
                                    <i class="iconfont">&#xe601;</i>
                                    <p>
                                        未选择
                                        <i class="iconfont">&#xeb6d;</i>
                                    </p>
                                    <div data-cover=''>
                                        <ul>
                                            <li>
                                                <i class="iconfont">&#xe601;</i>
                                                无需餐具
                                            </li>
                                            <li>1份</li>
                                            <li>2份</li>
                                            <li>3份</li>
                                            <li>4份</li>
                                            <li>5份</li>
                                            <li>6份</li>
                                        </ul>
                                    </div>
                                </div>
                                <button>确认下单</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <iframe src="./footer.html" frameborder="0" scrolling="no" class="frame-div" onload="this.height=100"></iframe>
    <div class="modal-bg"></div>
    <slider id="modal">
        <h2>添加新地址</h2>
        <div>
            <label>姓名</label>
            <input type="text" name="" id="uname" placeholder="请输入您的姓名">
        </div>
        <div>
            <label>性别</label>
            <input type="radio" name="gender" value="0"><span>先生</span>
            <input type="radio" name="gender" value="1"><span>女士</span>
        </div>
        <div data-address="">
            <label>位置</label>
            <input type="text" name="" id="txt_city" placeholder="请输入小区、大厦或者学校">
        </div>
        <div>
            <label>详细地址</label>
            <input type="text" name="" id="detail_address" placeholder="单元、门牌号">
        </div>
        <div>
            <label>手机号</label>
            <input type="text" name="" id="user_phone" placeholder="请输入您的手机号">
        </div>
        <div>
            <button data-save="">保存</button>
            <span data-cancal="">取消</span>
        </div>
    </slider>
    <script src="js/frame.js"></script>
    <script src="js/jquery.city.js"></script>


    <script>
        $(function () {
            $('#txt_city').jcity({
                urlOrData: 'js/citydata.json',
                animate: { showClass: 'animated flipInX', hideClass: 'animated flipOutX' },
                onChoice: function (data) {
                    console.log(data);
                }
            });
            var urlParams = new URLSearchParams(location.search);
            var sid = urlParams.get('sid');
            var user = urlParams.get('user');
            $.ajax({
                url: '/user/getOrderInfo',
                type: 'post',
                data: {
                    sid: sid,
                    user: user
                },
                dataType: 'json'
            }).then(function (data) {
                console.log(data);
                $('section>div:first-child>p:nth-child(2)').html(`${data[0].shop_name} >`);
                var li_content = '';
                var total_price = 0;
                for (let i = 0; i < data.length; i++) {
                    const obj = data[i];
                    li_content += `
                    <li class="food">
                        <span>
                            ${obj.name}
                        </span>
                        <span>
                            ￥${obj.un_price}*${obj.number}
                        </span>
                    </li>
                    `;
                    total_price += parseFloat(obj.un_price) * parseFloat(obj.number);
                }
                li_content += `
                    <li>
                    <span>包装费</span>
                    <span>￥2</span>
                    </li>
                    <li>
                        <span>配送费</span>
                        <span>￥${data[0].deliver_fee}</span>
                    </li>
                    <li>
                        <span>￥
                            <span>${total_price.toFixed(2)}</span>
                        </span>
                    </li>
                `;
                var ul = $('section>div:last-child>div:first-child>ul');
                ul.html(`${ul.html()}${li_content}`)
            })

            $('.time').on('click', 'li', function () {
                $(this).parent().parent().prev().html(`${$(this).html()} <i class="iconfont">&#xebe6;</i>`);
            })
            $('[data-cover]').on('click', 'li', function () {
                $(this).parent().parent().prev().html(`${$(this).html()} <i class="iconfont">&#xebe6;</i>`);
            })

            $.ajax({
                url: '/user/valiAddress',
                type: 'get',
                dataType: 'json'
            }).then((data) => {
                if (data.length) {
                    $('.add-address').addClass('has-address');
                    var $address = $(`
                    <i class="iconfont">&#xe64d;</i>
                    <span>
                        <span>
                            ${data[0].receiver} 男士 ${data[0].phone}
                        </span>
                        <span>
                            ${data[0].address}
                        </span>
                    </span>
                    <div class="tabs">
                        <i class="iconfont">&#xebe6;</i>
                    </div>
                    `)
                    $('.add-address').html('').prepend($address);
                } else {
                    function alert_address() {
                        $('#modal').show();
                        $('.modal-bg').show();
                        if ($('div[data-add-address]').has('.has-address')) {
                            $('div[data-add-address]').off('click');
                        } 
                    }
                    $('div[data-add-address]').on('click', alert_address);
                }
            })

            
            $('section>div:nth-child(2)>div:last-child h2>a').click(function () {
                $('#modal').show();
                $('.modal-bg').show();
            })
            $('span[data-cancal]').click(function () {
                $('.modal-bg').hide();
                $('#modal').hide();
            })
            $('.another-info>div>p').mouseenter(function () {
                $(this).next().show();
            })
            $('.another-info>div>div').mouseleave(function () {
                $(this).hide();
            })

            $('button[data-save]').click(function () {
                var gender = $('input[name=gender]:checked').val();
                var address = txt_city.value.replace(/\s*/ig, '').split('-');

                $.ajax({
                    url: '/user/save_address',
                    type: 'post',
                    data: {
                        u_phone: user,
                        receiver: uname.value,
                        province: address[0],
                        city: address[1],
                        country: address[2],
                        address: detail_address.value,
                        phone: user_phone.value
                    },
                    dataType: 'json'
                }).then(function (data) {
                    console.log(data)
                })

                $('.modal-bg').hide();
                $('#modal').hide();
                $('.add-address').addClass('has-address');
                var $address = $(`
                <i class="iconfont">&#xe64d;</i>
                <span>
                    <span>
                        ${uname.value} ${$('input[name=gender]:checked').next().html()} ${user_phone.value}
                    </span>
                    <span>
                        ${detail_address.value}
                    </span>
                </span>
                <div class="tabs">
                    <i class="iconfont">&#xebe6;</i>
                </div>
                `)
                $('.add-address').html('').prepend($address)

            })

            $('.another-info>button').click(function(){
                $.ajax({
                    url:'/user/saveOrder',
                    data:{
                        sid:sid,
                        user:user
                    },
                    type:'post',
                    dataType:'json'
                }).then((data) => {
                    console.log(data);
                })
            })
        })
    </script>
</body>

</html>