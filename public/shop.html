<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/popper.min.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/content/header.css">
    <link rel="stylesheet" href="css/icon/iconfont.css">
    <link rel="stylesheet" href="css/shop.css">
    <style>
    </style>
</head>

<body oncontextmenu="return false;" onselectstart="return false">
    <iframe src="./header.html" frameborder="0" scrolling="no" class="frame-div" onload="this.height=100"></iframe>
    <div class="container" id="app" v-cloak>
        <div class="business-info row m-0 mt-3">
            <div class="left-b col-md-6 pr-0">
                <div class="left-inner d-flex align-items-center">
                    <img src="img/business/business-icon.png" class="icon" alt="">
                    <div class="ml-2">
                        <p class="busin-title" v-if="category[0]">
                            <span>
                                {{category[0].foods[0].shop_name}}
                            </span>
                            <i class="iconfont">&#xeb6d;</i>
                        </p>
                        <div class="star" v-if="category[0]">
                            <i class="iconfont" v-for="(item, index) in category[0].foods[0].shop_start" :key="index">&#xec43;</i>
                            <span>
                                {{category[0].foods[0].shop_start}}分
                            </span>
                        </div>
                    </div>
                </div>
                <div class="mt-3 pl-2">
                    <p>
                        <i class="iconfont">&#xe68f;</i>
                        <span>营业时间</span>
                        <span>07:00-20:15</span>
                    </p>
                    <p>
                        <i class="iconfont">&#xec3f;</i>
                        <span>商家地址</span>
                        <span class="shop_address" v-if="category[0]">
                            {{category[0].foods[0].shop_name}}
                        </span>
                    </p>
                    <p>
                        <i class="iconfont">&#xe678;</i>
                        <span>商家电话</span>
                        <span class="shop_tel" v-if="category[0]">
                            {{category[0].foods[0].shop_phone}}
                        </span>
                    </p>
                </div>
            </div>
            <div class="taggle-btn">
                <i class="iconfont">&#xec0b;</i>
            </div>
            <div class="right-b col-md-6 col-sm-5 p-0 ">
                <div class="d-flex justify-content-between align-items-center detail-info" v-if="category[0]">
                    <div class="deliver_time">
                        <p>平均送餐时间</p>
                        <p><span>{{category[0].foods[0].deliver_time}}</span>分钟</p>
                    </div>
                    <div class="deliver_cost">
                        <p>起送</p>
                        <p><span>{{category[0].foods[0].deliver_cost}}</span>元</p>
                    </div>
                    <div class="deliver_fee">
                        <p>配送费</p>
                        <p><span>{{category[0].foods[0].deliver_fee}}</span>元</p>
                    </div>
                </div>
                <div class="save d-flex justify-content-center p-0 m-0">
                    <div class="align-self-center">
                        <p>收藏本店</p>
                        <i class="iconfont">&#xeca2;</i>
                    </div>
                </div>
            </div>
        </div>
        <div class="tabber m-0 p-0 mt-3 row">
            <ul class="d-flex justify-content-around col-xl-4 col-lg-4 col-md-4 col-sm-5 p-0">
                <li>
                    <a href="#">所有商品</a>
                </li>
                <li>
                    <a href="#">评价</a>
                </li>
                <li>
                    <a href="#">商家资质</a>
                </li>
            </ul>
            <div class="offset-xl-3 col-xl-5 offset-lg-1 col-lg-7 offset-md-2 col-md-6 col-sm-7 p-0">
                <ul class="d-flex sort-info m-0">
                    <li>
                        <a href="#" class="rank">
                            <i class="iconfont">&#xe73f;</i>
                            <i class="iconfont">&#xe742;</i>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="food_item" v-if="category[0]">
            <div class="d-flex">
                <div class="category mt-3">
                    <ul class="d-flex flex-wrap pt-3 pl-4 m-0" v-if="category[0]">
                        <li v-for="(obj, index) in category[0].catagory" :key="index">
                            <a :href="'#item'+(index+1)" :data-target="'#item'+(index+1)">{{obj.type_name}}</a>
                        </li>
                    </ul>
                </div>
                <div class="mt-3 concat">
                    <p>商家公告</p>
                    <div>
                        <h4>配送说明</h4>
                        <p v-if="category[0]">配送费 ￥{{category[0].foods[0].deliver_fee}}</p>
                    </div>
                </div>
            </div>
            <div v-if="category[0]" v-for="(obj, index) in category[0].catagory" :key="index" class="goods" :id="'item'+(index+1)">
                <div class="goods-type">
                    <p class="goods-title" id="item1">{{obj.type_name}}</p>
                    <ul>
                        <li v-for="(food, index) in category[0].foods" :key="index" v-if="food.foot_type == obj.type_name">
                            <img :src="food.food_img" alt="" class="goods-img">
                            <div>
                                <p>{{food.name}}</p>
                                <p>{{food.ingredients}}</p>
                                <div class="star">
                                    <i class="iconfont">&#xec43;</i>
                                    <i class="iconfont">&#xec43;</i>
                                    <i class="iconfont">&#xec43;</i>
                                    <i class="iconfont">&#xec43;</i>
                                    <i class="iconfont">&#xec43;</i>
                                    <span>
                                        ({{food.food_start}}分)月售200+份
                                    </span>
                                </div>
                                <p v-if="getCount(food.food_id)<1">
                                    <span class="price">￥{{food.price}}</span>
                                    <a href="javascript:;" @click="add_to_shopCar($event,food.name,food.price,food.food_id)">加入购物车</a>
                                    <input type="hidden" class="food_id" :value="food.food_id">
                                </p>
                                <div v-if="getCount(food.food_id)>=1" class="change_food_count">
                                    <span class="price">￥{{food.price}}</span>
                                    <p>
                                        <button @click="change(-1, food.food_id)">-</button>
                                        <input type="text" :value="getCount(food.food_id)">
                                        <button @click="change(+1, food.food_id)">+</button>
                                        <input type="hidden" class="food_id" :value="food.food_id">
                                    </p>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="shop-car">
            <div>
                <p>
                    <span>购物车</span>
                    <span @click="clear"><a href="javascript:;">[清空]</a></span>
                </p>
                <i class="iconfont">&#xe640;</i>
            </div>
            <div v-for="obj in shop_car">
                <div class="shop-item">
                    <ul>
                        <li>
                            <span class="goods-name">{{obj.name}}</span>
                            <p>
                                <button @click="change(-1, obj.fid)">-</button>
                                <input type="text" v-model="obj.number">
                                <button @click="change(+1, obj.fid)">+</button>
                                <input type="hidden" :value="obj.fid">
                            </p>
                            <span class="unprice">
                                ￥{{obj.un_price * obj.number}}
                            </span>
                        </li>
                    </ul>
                </div>
            </div>
            <div>
                <a href="#">
                    <i class="iconfont">&#xe63f;</i>
                    <i class="number">{{count_total}}</i>
                    <span>￥</span>
                    <span class="total">{{price_total}}</span>
                    <span></span>
                </a>
                <a href="#">
                    <span @click="toOrder">
                        去结算 >
                    </span>
                </a>
            </div>
        </div>
    </div>
    <iframe src="./footer.html" frameborder="0" scrolling="no" class="frame-div" onload="this.height=100"></iframe>
    <script src="js/frame.js"></script>
    <script src="js/vue.js"></script>
    <script>
        new Vue({
            el: '#app',
            data: {
                sid: '',
                user: '',
                category: [],
                foods_type: [],
                shop_car: [],
            },
            mounted() {
                this.set_sid_user();
                this.load_food().then(this.bandClick);
                this.load_shop_car();
            },
            methods: {
                getCount:function (food_id) {
                    for (const key in this.shop_car) {
                        if (this.shop_car.hasOwnProperty(key)) {
                            const element = this.shop_car[key];
                            if (element.fid == food_id) {
                                return element.number;
                            }
                        }
                    }
                    return 0;
                },
                load_food: function () {
                    var _self = this;
                    return new Promise(function (open) {
                        $.ajax({
                            url: "/user/getFoodsCatagory",
                            type: "get",
                            data: {
                                sid: _self.sid
                            },
                            dataType: "json"
                        }).then(function (data) {
                            _self.category = _self.category.concat(data);
                            open();
                        })
                    })
                },
                bandClick: function () {
                    return new Promise(function (open) {
                        $('.category ul li:first-child').addClass('type-active');
                        $('.category>ul').on('click', 'li', function (e) {
                            $(this).addClass('type-active').siblings('li').removeClass('type-active').css({ 'background': '#fff' });
                        })
                        $('.category ul li').hover(function () {
                            $(this).not('.type-active').css({ 'background': '#eee' });
                        }, function () {
                            $(this).not('.type-active').css({ 'background': '#fff' });
                        })
                    })
                },
                set_sid_user: function () {
                    var urlParams = new URLSearchParams(location.search);
                    this.sid = urlParams.get("sid");
                    this.user = urlParams.get('user');
                },
                load_shop_car: function () {
                    var _self = this;
                    $.ajax({
                        url: "/user/load_shop_car",
                        type: "get",
                        data: {
                            user: this.user
                        },
                        dataType: "json"
                    }).then(function (data) {
                        _self.shop_car = data;
                    })
                },
                toOrder: function () {
                    location.href = `${location.origin}/order.html?sid=${this.sid}&user=${this.user}`;
                },
                clear: function () {
                    this.shop_car = [];

                    $.ajax({
                        url: '/user/delete_shop_car',
                        type: 'get',
                        dataType: 'json',
                        data: {
                            user: this.user
                        }
                    }).then(function (data) {
                        console.log(data);
                    })
                },
                add_to_shopCar: function (e, name, price, f_id) {
                    var _self = this;
                    $.ajax({
                        url: "/user/setShopCar",
                        type: "post",
                        data: {
                            foods_id: f_id,
                            un_price: price,
                            user: this.user,
                            sid: this.sid
                        },
                        dataType: "json"
                    }).then(function (data) {
                        console.log('重新加载')
                        _self.load_shop_car();
                    });
                    for (const key in this.category[0].foods) {
                        if (this.category[0].foods.hasOwnProperty(key)) {
                            const element = this.category[0].foods[key];
                        }
                    }
                },
                change: function (i, f_id) {
                    var _self = this;
                    for (const key in this.shop_car) {
                        if (this.shop_car.hasOwnProperty(key)) {
                            const element = this.shop_car[key];
                            if (element.fid == f_id) {
                                element.number += i;
                                if (element.number <= 0) {
                                    element.number = 0;
                                    _self.load_shop_car()
                                }
                                console.log(element.number)
                                $.ajax({
                                    url: "/user/update_shopCar",
                                    type: "post",
                                    data: {
                                        foods_id: f_id,
                                        number: element.number
                                    },
                                    dataType: 'json'
                                }).then(function (data) {
                                })
                            }
                        }
                    }
                }
            },
            computed: {
                count_total: function () {
                    var sum = 0;
                    for (const key in this.shop_car) {
                        if (this.shop_car.hasOwnProperty(key)) {
                            const element = this.shop_car[key];
                            sum += element.number;
                        }
                    }
                    return sum;
                },
                price_total: function () {
                    var sum = 0;
                    for (const key in this.shop_car) {
                        if (this.shop_car.hasOwnProperty(key)) {
                            const element = this.shop_car[key];
                            sum += element.number * element.un_price;
                        }
                    }
                    return sum.toFixed(2);
                }
            },
        })
    </script>

    <script>
        var title = $('.left-inner');
        var heart = $('.save>div>i');

        title.hover(function () {
            $('.left-b').addClass('left-b-show-all');
            $('.busin-title>.iconfont').html('&#xeb6e;');
        }, function () {
            $('.left-b').removeClass('left-b-show-all');
            $('.busin-title>.iconfont').html('&#xeb6d;');
        });

        $('.right-b div i').click(function () {
            if ($('.right-b div i').css('color') == 'rgb(106, 106, 106)') {
                $('.right-b div i').html('&#xeca1;');
                $('.right-b div i').css('color', '#e54c2a')
            } else {
                $('.right-b div i').html('&#xeca2;');
                $('.right-b div i').css('color', '#6a6a6a')
            }

        })

        $('.taggle-btn').click(function () {
            if ($('.right-b').css('display') == 'none') {
                $('.right-b').css('border-width', '1px')
                $('.right-b').css('border-style', 'solid')
                $('.right-b').css('border-color', '#ccc')
                $('.right-b').css('border-top-color', '#fff')
                $('.right-b').css('display', 'inherit')
            } else {
                $('.right-b').css('display', 'none')
                $('.right-b').css('border', 'none')
            }
        })
        $(window).resize(function () {
            if ($('.taggle-btn').css('display') == 'none') {
                $('.right-b').css('display', 'inherit')
                $('.right-b').css('border', 'none')
            } else {
                $('.right-b').css('display', 'none')
            }
        })
        window.onscroll = function () {
            var scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
            if (scrollTop < 500) {
                var div = document.getElementsByClassName('category')[0]
                div.classList.remove('fixed-div');
            };
            if (scrollTop >= 500) {
                var div = document.getElementsByClassName('category')[0]
                div.classList.add('fixed-div');
            };
            if ($('.goods').length > 0) {

                var windowTop = 500;
                var arr = {};
                var goods_div = document.getElementsByClassName('goods')
                for (const elem of goods_div) {
                    arr[$(elem).attr('id')] = elem.scrollHeight;
                }

                var countLeft = 0, countRight = 0;
                for (const key in arr) {
                    countLeft = countRight;
                    countRight += arr[key];
                    if (scrollTop > windowTop + countLeft && scrollTop < windowTop + countRight) {
                        $(`a[data-target="#${key}"]`).parent().addClass('type-active').siblings().removeClass('type-active');
                    }
                }
            }
        }
    </script>
</body>
</html>