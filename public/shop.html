<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/popper.min.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap3.7.css">
    <link rel="stylesheet" href="css/content/header.css">
    <link rel="stylesheet" href="css/icon/iconfont.css">
    <link rel="stylesheet" href="css/shop.css">
    <style>
        .fixed-div {
            position: fixed;
            top: 0;
            margin-top: 0px !important;
            box-shadow: 0px 0px 5px #ccc;
        }
    </style>
</head>

<body oncontextmenu="return false;" onselectstart="return false">
    <iframe src="./header.html" frameborder="0" scrolling="no" class="frame-div" onload="this.height=100"></iframe>
    <div class="container">
        <div class="business-info row m-0 mt-3">
            <div class="left-b col-md-6 pr-0">
                <div class="left-inner d-flex align-items-center">
                    <img src="img/business/business-icon.png" class="icon" alt="">
                    <div class="ml-2">
                        <p class="busin-title">
                            <span></span>
                            <i class="iconfont">&#xeb6d;</i>
                        </p>
                        <div class="star">
                            <span></span>
                        </div>
                    </div>
                </div>
                <div class="mt-3 pl-2">
                    <p>
                        <i class="iconfont">&#xe68f;</i>
                        <span>营业时间</span>
                        <span>07:00-20:15</span>
                    </p>
                    <p>
                        <i class="iconfont">&#xec3f;</i>
                        <span>商家地址</span>
                        <span class="shop_address"></span>
                    </p>
                    <p>
                        <i class="iconfont">&#xe678;</i>
                        <span>商家电话</span>
                        <span class="shop_tel"></span>
                    </p>
                </div>
            </div>
            <div class="taggle-btn">
                <i class="iconfont">&#xec0b;</i>
            </div>
            <div class="right-b col-md-6 col-sm-5 p-0 ">
                <div class="d-flex justify-content-between align-items-center detail-info">
                    <div class="deliver_time">
                        <p>平均送餐时间</p>
                        <p><span></span>分钟</p>
                    </div>
                    <div class="deliver_cost">
                        <p>起送</p>
                        <p><span></span>元</p>
                    </div>
                    <div class="deliver_fee">
                        <p>配送费</p>
                        <p><span></span>元</p>
                    </div>
                </div>
                <div class="save d-flex justify-content-center p-0 m-0">
                    <div class="align-self-center">
                        <p>收藏本店</p>
                        <i class="iconfont">&#xeca2;</i>
                    </div>
                </div>
            </div>
        </div>
        <div class="tabber m-0 p-0 mt-3 row">
            <ul class="d-flex justify-content-around col-xl-4 col-lg-4 col-md-4 col-sm-5 p-0">
                <li>
                    <a href="#">所有商品</a>
                </li>
                <li>
                    <a href="#">评价</a>
                </li>
                <li>
                    <a href="#">商家资质</a>
                </li>
            </ul>
            <div class="offset-xl-3 col-xl-5 offset-lg-1 col-lg-7 offset-md-2 col-md-6 col-sm-7 p-0">
                <ul class="d-flex sort-info m-0">
                    <li>
                        <a href="#" class="rank">
                            <i class="iconfont">&#xe73f;</i>
                            <i class="iconfont">&#xe742;</i>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="food_item">
            <div class="d-flex">
                <div class="category mt-3">
                    <ul class="d-flex flex-wrap pt-3 pl-4 m-0"></ul>
                </div>
                <div class="mt-3 concat">
                    <p>商家公告</p>
                    <div>
                        <h4>配送说明</h4>
                        <p></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="shop-car">
            <div>
                <p>
                    <span>购物车</span>
                    <span><a href="#">[清空]</a></span>
                </p>
                <i class="iconfont">&#xe640;</i>
            </div>
            <div></div>
            <div>
                <a href="#">
                    <i class="iconfont">&#xe63f;</i>
                    <i class="number">0</i>
                    <span>￥</span>
                    <span class="total">000.00</span>
                    <span></span>
                </a>
                <a href="#">
                    <span>
                        去结算 >
                    </span>
                </a>
            </div>

        </div>
    </div>
    <iframe src="./footer.html" frameborder="0" scrolling="no" class="frame-div" onload="this.height=100"></iframe>
    <script src="js/frame.js"></script>
    <script src="js/ajax.js"></script>
    <script>
        $(function () {
            var urlParams = new URLSearchParams(location.search);
            var sid = urlParams.get("sid");
            var user = urlParams.get('user');

            function load_food() {
                return new Promise(function (open) {
                    ajax({
                        url: "/user/getFoodsCatagory",
                        type: "get",
                        data: `sid=${sid}`,
                        dataType: "json"
                    }).then(function (data) {
                        var li_html = '';
                        var item_title = '';
                        for (let i = 0; i < data.length; i++) {
                            li_html += `<li><a href="#item${i + 1}">${data[i].type_name}</a></li>`
                            item_title += `
                            <div class="goods">
                                <div class="goods-type">
                                    <p class="goods-title" id="item1">${data[i].type_name}</p><ul></ul>
                                </div>
                            </div>`;
                        }
                        $('.category ul').html(li_html);
                        // console.log(item_title)
                        $('.food_item').html(`${$('.food_item').html()}${item_title}`)
                        open();
                    })
                })

            }
            function load_type() {
                return new Promise(function (open) {
                    ajax({
                        url: "/user/getFoods",
                        type: "get",
                        data: `sid=${sid}`,
                        dataType: "json"
                    }).then(function (data) {
                        $('.busin-title span').html(data[0].shop_name)
                        var start_icon = '';
                        for (let i = 0; i < data[0].shop_start; i++) {
                            start_icon += '<i class="iconfont">&#xec43;</i>';
                        }
                        $('.star').html(`${start_icon} <span>${data[0].shop_start}分</span>`);
                        $('.shop_address').html(data[0].address);
                        $('.shop_tel').html(data[0].shop_phone);
                        $('.deliver_time p span').html(data[0].deliver_time);
                        $('.concat div p').html(`配送费：￥ ${parseFloat(data[0].deliver_fee).toFixed(2)}`);
                        $('.deliver_cost p span').html(data[0].deliver_cost);
                        $('.deliver_fee p span').html(data[0].deliver_fee);
                        $('.total').next().html(`| 配送费￥${data[0].deliver_fee}`)
                        var food_items = '';
                        var goods_title = document.querySelectorAll(".goods>.goods-type>.goods-title")
                        for (const obj of data) {
                            for (let i = 0; i < goods_title.length; i++) {
                                const element = goods_title[i];
                                var text = element.textContent;
                                if (obj.foot_type == text) {
                                    element.parentNode.lastElementChild.innerHTML += `<li>
                                        <img src="${obj.food_img}" alt="" class="goods-img">
                                        <div>
                                            <p>${obj.name}</p>
                                            <p>${obj.ingredients}</p>
                                            <div class="star">
                                                <i class="iconfont">&#xec43;</i>
                                                <i class="iconfont">&#xec43;</i>
                                                <i class="iconfont">&#xec43;</i>
                                                <i class="iconfont">&#xec43;</i>
                                                <i class="iconfont">&#xec43;</i>
                                                <span>
                                                    (${obj.food_start}分)月售200+份
                                                    </span>
                                                    </div>
                                                    <p>
                                                        <span class="price">￥${obj.price}</span>
                                                        <a href="javascript:;">加入购物车</a>
                                                        <input type="hidden" class="food_id" value="${obj.food_id}">
                                                    </p>
                                        </div>
                                    </li>
                                    `
                                }
                            }
                        }
                    })
                })
            }

            load_food().then(load_type);

            $('.food_item').on('click', 'div', function (e) {
                e.stopPropagation();
                var a = e.target.nodeName;
                if (a == 'A') {
                    $('.number').html(parseInt($('.number').text()) + 1);
                    var g_name = e.target.parentElement.parentElement.firstElementChild.innerHTML;
                    var un_price = e.target.previousElementSibling.innerHTML;
                    var f_id = e.target.nextElementSibling.value;
                    $('.shop-car>div:nth-child(2)').html(`
                    ${ $('.shop-car>div:nth-child(2)').html()}
                    <div class="shop-item">
                        <ul>
                            <li>
                                <span class="goods-name">${g_name}</span>
                                <p>
                                    <button>-</button>
                                    <input type="text" value="1">
                                    <button>+</button>
                                    <input type="text" value="${f_id}">
                                </p>
                                <span class="unprice">
                                ${un_price}
                                </span>
                            </li>
                        </ul>
                    </div>`);

                    ajax({
                        url: "/user/setShopCar",
                        type: "post",
                        data: `foods_id=${f_id}&un_price=${un_price}&user=${user}`,
                        dataType: "json"
                    }).then(function (data) {
                        cal_total();
                    })
                }
            })

            $('.shop-car>div:nth-child(2)').click(function (e) {
                if (e.target.nodeName == 'BUTTON') {
                    var fid = e.target.parentNode.lastElementChild.value;
                    var count = parseInt(e.target.parentNode.firstElementChild.nextElementSibling.value);
                    if (e.target.innerHTML == '+') {
                        count = e.target.parentNode.firstElementChild.nextElementSibling.value = count + 1;
                        var n = parseInt($('.number').text()) + 1;
                        $('.number').text(n)
                    } else {
                        if (count > 1) {
                            count = e.target.parentNode.firstElementChild.nextElementSibling.value = count - 1;
                        }
                    }
                    ajax({
                        url: "/user/update_shopCar",
                        type: "post",
                        data: `foods_id=${fid}&number=${count}`,
                        dataType: "json"
                    }).then(function (data) {
                        var obj = data[0];
                        var un_tatle = e.target.parentNode.nextElementSibling;
                        un_tatle.innerHTML = `￥${parseFloat(count * obj.un_price)}`;
                        setTimeout(() => {
                            cal_total();
                        }, 500);

                    })

                }
            })

            ajax({
                url: "/user/load_shop_car",
                type: "get",
                dataType: "json"
            }).then(function (data) {
                var food_count = 0;
                for (const key in data) {
                    $('.shop-car>div:nth-child(2)').html(`
                    ${ $('.shop-car>div:nth-child(2)').html()}
                    <div class="shop-item">
                        <ul>
                            <li>
                                <span class="goods-name">${data[key].name}</span>
                                <p>
                                    <button>-</button>
                                    <input type="text" value="${data[key].number}">
                                    <button>+</button>
                                    <input type="text" value="${data[key].fid}">
                                </p>
                                <span class="unprice">
                                ￥${data[key].un_price*data[key].number}
                                </span>
                            </li>
                        </ul>
                    </div>`);
                    cal_total()
                    food_count += parseInt(data[key].number); 
                }
                $('.number').html(food_count)
            })
        })

        var title = $('.left-inner');
        var heart = $('.save>div>i');

        title.hover(function () {
            $('.left-b').addClass('left-b-show-all');
            $('.busin-title>.iconfont').html('&#xeb6e;');
        }, function () {
            $('.left-b').removeClass('left-b-show-all');
            $('.busin-title>.iconfont').html('&#xeb6d;');
        });

        heart.hover(function () {
            $('.right-b div i').html('&#xeca1;');
            $('.right-b div i').css('color', '#e54c2a')
        }, function () {
            $('.right-b div i').html('&#xeca2;');
            $('.right-b div i').css('color', '#6A6A6A')
        });

        $('.taggle-btn').click(function () {
            if ($('.right-b').css('display') == 'none') {
                $('.right-b').css('border-width', '1px')
                $('.right-b').css('border-style', 'solid')
                $('.right-b').css('border-color', '#ccc')
                $('.right-b').css('border-top-color', '#fff')
                $('.right-b').css('display', 'inherit')
            } else {
                $('.right-b').css('display', 'none')
                $('.right-b').css('border', 'none')
            }
        })
        $(window).resize(function () {
            if ($('.taggle-btn').css('display') == 'none') {
                $('.right-b').css('display', 'inherit')
                $('.right-b').css('border', 'none')
            } else {
                $('.right-b').css('display', 'none')
            }
        })
        window.onscroll = function () {
            var scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
            if (scrollTop < 500) {
                var div = document.getElementsByClassName('category')[0]
                div.classList.remove('fixed-div');
            };
            if (scrollTop >= 500) {
                var div = document.getElementsByClassName('category')[0]
                div.classList.add('fixed-div');
            };
        }
        function cal_total() {
            var moneys = $('.unprice');
            var total = 0;;
            moneys.each(function () {
                var str = $(this).text();
                var reg = /(^\s*[￥])|(\s*$)/g;
                str = str.replace(reg, '');
                total += parseFloat(str);
            })
            $('.total').html(`${total.toFixed(2)}`)
        }

        $('.shop-car>div>p>span>a').click(function(){
            $('.shop-car>div:nth-child(2)').html('');
            $('.number').html('0');
            $('.total').html('00.00');
            ajax({
                url: '/user/delete_shop_car',
                type: 'get',
                dataType: 'json'
            }).then(function(data){
                console.log(data);
            })
        })
    </script>
</body>

</html>